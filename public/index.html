<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Controle de Jornada</title>
  <script>window.$ = window.jQuery = require('./jquery.min.js');</script>
  <!-- <script src="jquery.min.js" type="text/javascript"></script> -->
  <script src="bundle.js" type="text/javascript"></script>
</head>

<body style="display: none;"  id="report">
  <main>
    <nav class="navbar navbar-inverse">
      <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand" href="#">Controle de Jornada</a>
        </div>
      </div>
    </nav>
    <div class="container">
      <div class="row">
        <div class="col-xs-6 col-xs-offset-3">
          <form class="jumbotron" id="auth">
            <div class="form-group">
              <label for="" class="label-control">Servidor</label>
              <input type="text" class="form-control" name="server" id="server" placeholder="https://meujira.com.br" required>
            </div>
            <div class="form-group">
              <label for="" class="label-control">Usuário</label>
              <input type="text" class="form-control" name="username" id="username" placeholder="Usuário" required>
            </div>
            <div class="form-group">
              <label for="" class="label-control">Senha</label>
              <input type="password" class="form-control" name="password" id="password" required>
            </div>
            <div class="form-group">
              <label for="" class="label-control">Projeto</label>
              <input type="text" class="form-control" name="project" id="project" required>
            </div>
            <div class="row">
              <div class="col-xs-6">
                <a class="btn btn-default btn-block" href="logado.html">Voltar</a>
              </div>
              <div class="col-xs-6">
                <button type="submit" class="btn btn-primary btn-block">Salvar</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </main>
</body>
<script>
$(function() {
  function auth(authData, shouldNotAlert = false, callback) {
    $.ajax({
      cache: false,
      type: "POST",
      data: JSON.stringify(authData),
      dataType: 'json',
      url: `http://localhost:5000/auth`,
      contentType: 'application/json',
    })
    .done(function(data) {
      console.log('Login!', data)
      authData.lastLogin = new Date()
      localStorage.setItem('jira-worklog-v1', btoa(JSON.stringify(authData)));
      callback && callback()
      // window.location.href = 'logado.html';
    })
    .fail(function (jqXHR, textStatus, errorThrown ) {
      $('body').fadeIn();
      console.log('ERROR:', textStatus, errorThrown, jqXHR)
      if (!shouldNotAlert) {
        alert(`Erro! ${jqXHR.responseJSON.message ? jqXHR.responseJSON.message : ''}`)
      }
    })
  }
  $("#username").focus();
  var savedData = localStorage.getItem('jira-worklog-v1') || null;
  savedData = savedData ? JSON.parse(atob(savedData)) : null;
  if (savedData && (Math.abs(new Date() - new Date(savedData.lastLogin || 0)) / 86400000 / 3600000) <= 8) {
    auth(savedData, true)
    $('body').fadeIn();
    // return;
  }
  else {
    $('body').fadeIn();
  }
  if (savedData) {
    console.log('Login time', (Math.abs(new Date() - new Date(savedData.lastLogin || 0)) / 86400000 / 3600000));
    Object.keys(savedData).forEach(function(key) {
      if (key === 'password') return
      $(`#${key}`).val(savedData[key])
    })
  }
  console.log('saved', savedData)

  var $form = $('#auth');
  $('body').on('submit', '#auth', function(e) {
    // e.preventDefault();
    var authData = $form.serializeArray();
    authData = authData.reduce(function(prev, cur) {
      prev[cur.name] = cur.value;
      return prev;
    }, {});
    auth(authData, false, () => {
      window.location.href = 'logado.html'
    })
    return false;
  // }).on('keydown keypress keyup', 'input', function(event){
  //   if( (event.keyCode == 13) && (validationFunction() == false) ) {
  //     event.preventDefault();
  //     return false;
  //   }
  });
})
</script>
</html>
